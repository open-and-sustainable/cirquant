# PRQL query for converting PRODCOM units to tonnes
# This query applies unit conversion factors to standardize all quantities to tonnes

# First, extract unit information from QNTUNIT indicator
let unit_data = (
    from prodcom_ds_059358_{{YEAR}}
    filter indicators == "QNTUNIT"
    select {
        product_code = prccode,
        unit_raw = value,
        geo = reporter
    }
    derive {
        unit = s"lower(unit_raw)"
    }
)

let weight_data = (
    from prodcom_unit_weights
    select {
        product_code,
        weight_tonnes
    }
)

# Extract quantity values from PRODQNT indicator
let quantity_data = (
    from prodcom_ds_059358_{{YEAR}}
    filter indicators == "PRODQNT"
    # Filter out rows where value contains unit strings instead of numbers
    filter value != "kg" && value != "p/st" && value != "ce/el" && value != "m" && value != "m2" && value != "m3" && value != "l" && value != "hl" && value != "ct/l"
    derive {
        quantity_value = s"TRY_CAST(value AS DOUBLE)"
    }
    filter quantity_value != null
    select {
        product_code = prccode,
        geo = reporter,
        quantity_raw = quantity_value
    }
)

# Join quantity data with units
from quantity_data
join side:left unit_data (quantity_data.product_code == unit_data.product_code && quantity_data.geo == unit_data.geo)
join side:left weight_data (quantity_data.product_code == weight_data.product_code)
derive {
    # Apply conversion factors based on unit type
    conversion_factor = s"""
        CASE
            -- Direct weight conversions
            WHEN unit_data.unit = 'kg' THEN 0.001  -- kg to tonnes
            WHEN unit_data.unit = 't' THEN 1.0     -- already tonnes

            -- Piece/unit conversions (product-specific)
            WHEN unit_data.unit IN ('p/st', 'pst') THEN
                CASE
                    WHEN weight_data.weight_tonnes IS NOT NULL THEN weight_data.weight_tonnes
                    -- Default for pieces
                    ELSE 0.010  -- 10kg default
                END

            -- Battery cells/elements
            WHEN unit_data.unit = 'ce/el' THEN 0.0003  -- ~300g per cell

            -- If no unit found, assume kg
            WHEN unit_data.unit IS NULL THEN 0.001

            -- Unknown unit: preserve value
            ELSE 1.0
        END
    """,

    # Calculate quantity in tonnes
    quantity_tonnes = quantity_data.quantity_raw * conversion_factor,

    # Flag conversions for quality tracking
    conversion_method = s"""
        CASE
            WHEN unit_data.unit = 'kg' THEN 'direct'
            WHEN unit_data.unit = 't' THEN 'direct'
            WHEN unit_data.unit = 'p/st' THEN 'average-weight'
            WHEN unit_data.unit = 'ce/el' THEN 'average-weight'
            WHEN unit_data.unit IS NULL THEN 'assumed-kg'
            ELSE 'unknown'
        END
    """
}

# Select final converted data
select {
    product_code = quantity_data.product_code,
    geo = quantity_data.geo,
    year = s"{{YEAR}}",
    quantity_tonnes,
    original_quantity = quantity_data.quantity_raw,
    original_unit = s"COALESCE(unit_data.unit, 'kg')",
    conversion_factor,
    conversion_method
}

# Filter out non-convertible or invalid results
filter quantity_tonnes > 0
sort {product_code, geo}
